<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patron Paneli - Kuaför Aura</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Outfit:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/css/aura-ui.css">
    <link rel="stylesheet" href="/css/dashboard-aura.css">
    <style>
        .dashboard {
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            padding: var(--spacing-md);
            border-right: 1px solid var(--border-color);
        }

        .sidebar-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--spacing-md);
        }

        .sidebar-menu {
            list-style: none;
        }

        .menu-item {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .menu-item:hover {
            background: var(--bg-tertiary);
        }

        .menu-item.active {
            background: var(--primary);
        }

        .main-content {
            flex: 1;
            padding: var(--spacing-lg);
            overflow-y: auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: var(--spacing-sm) 0;
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.875rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background: var(--bg-tertiary);
            font-weight: 600;
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        /* Staff Pro Modal Styles */
        .modal-tabs {
            display: flex;
            gap: 1rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--spacing-md);
        }

        .modal-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            transition: all var(--transition-fast);
        }

        .modal-tab:hover {
            color: var(--text-primary);
        }

        .modal-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .table-mini {
            font-size: 0.8125rem;
            width: 100%;
        }

        .table-mini th,
        .table-mini td {
            padding: 0.5rem;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Outfit', sans-serif !important;
            letter-spacing: -0.022em !important;
        }
    </style>
</head>

<body class="aura-theme">
    <div class="mesh-bg"></div>
    <div class="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2 style="font-weight: 700; font-size: 1.5rem;">Kuaför Aura</h2>
                <p class="text-muted" id="userInfo"></p>
                <p class="text-muted" style="font-size: 0.75rem;" id="salonInfo"></p>
            </div>
            <ul class="sidebar-menu">
                <li class="menu-item active" data-page="dashboard"><i class="fas fa-home"
                        style="margin-right: 0.5rem;"></i>Dashboard</li>
                <li class="menu-item" data-page="appointments"><i class="fas fa-calendar-check"
                        style="margin-right: 0.5rem;"></i>Randevular</li>
                <li class="menu-item" data-page="analytics"><i class="fas fa-chart-line"
                        style="margin-right: 0.5rem;"></i>Analitik</li>
                <li class="menu-item" data-page="staff"><i class="fas fa-users"
                        style="margin-right: 0.5rem;"></i>Personel</li>
                <li class="menu-item" data-page="catalog"><i class="fas fa-list"
                        style="margin-right: 0.5rem;"></i>Katalog</li>
                <li class="menu-item" data-page="stock"><i class="fas fa-boxes" style="margin-right: 0.5rem;"></i>Stok
                </li>
                <li class="menu-item" onclick="logout()"><i class="fas fa-sign-out-alt"
                        style="margin-right: 0.5rem;"></i>Çıkış</li>
            </ul>
        </aside>

        <main class="main-content fade-in">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content">
                <h1>Salon Özeti</h1>

                <div class="stats-grid" id="statsGrid">
                    <!-- Stats buraya yüklenecek -->
                </div>

                <!-- Analytics Summary -->
                <div class="card mt-lg">
                    <div class="card-header flex-between">
                        <h3 class="card-title"><i class="fas fa-chart-pie" style="margin-right: 0.5rem;"></i>Analitik
                            Özeti</h3>
                        <button class="btn btn-primary btn-sm" onclick="navigateToAnalytics()">Detaylı Analitik
                            →</button>
                    </div>
                    <div style="padding: var(--spacing-md);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                            <!-- Top Customers Widget -->
                            <div>
                                <h4
                                    style="margin-bottom: var(--spacing-sm); color: var(--text-muted); font-size: 0.875rem;">
                                    En Sadık Müşteriler (Son 30 Gün)</h4>
                                <div id="topCustomersWidget">
                                    <p class="text-muted">Yükleniyor...</p>
                                </div>
                            </div>
                            <!-- Popular Services Widget -->
                            <div>
                                <h4
                                    style="margin-bottom: var(--spacing-sm); color: var(--text-muted); font-size: 0.875rem;">
                                    Popüler Hizmetler (Son 30 Gün)</h4>
                                <div id="popularServicesWidget">
                                    <p class="text-muted">Yükleniyor...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-lg">
                    <div class="card-header">
                        <h3 class="card-title">Gelir Trendi (Son 7 Gün)</h3>
                    </div>
                    <div style="padding: var(--spacing-md);">
                        <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <!-- Pending Staff Approvals -->
                <div class="card mt-lg" id="pendingStaffCard" style="display: none;">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-user-clock" style="margin-right: 0.5rem;"></i>Bekleyen
                            Personel Onayları</h3>
                    </div>
                    <div id="pendingStaffList" style="padding: var(--spacing-md);"></div>
                </div>

                <div class="card mt-lg">
                    <div class="card-header">
                        <h3 class="card-title">Personel Performansı</h3>
                    </div>
                    <div id="staffPerformance"></div>
                </div>
            </div>

            <!-- Appointments Page -->
            <div id="appointmentsPage" class="page-content hidden">
                <div class="flex-between mb-md">
                    <h1><i class="fas fa-calendar-check" style="margin-right: 0.5rem;"></i>Randevu Yönetimi</h1>
                    <button class="btn btn-primary btn-sm" onclick="showManualAppointmentModal()">
                        <i class="fas fa-plus"></i> Manuel Randevu Oluştur
                    </button>
                </div>

                <!-- Filters -->
                <div class="card mb-lg">
                    <div class="grid grid-4 gap-md" style="padding: var(--spacing-md);">
                        <div class="form-group">
                            <label>Durum</label>
                            <select id="filterStatus" class="form-control" onchange="loadAppointments()">
                                <option value="">Tümü</option>
                                <option value="pending">Bekliyor</option>
                                <option value="completed">Tamamlandı</option>
                                <option value="cancelled">İptal</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Personel</label>
                            <select id="filterStaff" class="form-control" onchange="loadAppointments()">
                                <option value="">Tümü</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Başlangıç</label>
                            <input type="date" id="filterDateFrom" class="form-control" onchange="loadAppointments()">
                        </div>
                        <div class="form-group">
                            <label>Bitiş</label>
                            <input type="date" id="filterDateTo" class="form-control" onchange="loadAppointments()">
                        </div>
                    </div>
                </div>

                <!-- Appointments Table -->
                <div class="card">
                    <table id="appointmentsTable">
                        <thead>
                            <tr>
                                <th>Tarih/Saat</th>
                                <th>Müşteri</th>
                                <th>Hizmet</th>
                                <th>Personel</th>
                                <th>Fiyat</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Page -->
            <div id="analyticsPage" class="page-content hidden">
                <h1><i class="fas fa-chart-bar" style="margin-right: 0.5rem;"></i>Detaylı Analitik</h1>

                <!-- Date Filter -->
                <div class="card mb-lg">
                    <div
                        style="padding: var(--spacing-md); display: flex; gap: var(--spacing-md); align-items: center;">
                        <label style="font-weight: 600;">Tarih Aralığı:</label>
                        <select id="dateRangeFilter" class="form-control" style="width: auto;">
                            <option value="7">Son 7 Gün</option>
                            <option value="30" selected>Son 30 Gün</option>
                            <option value="90">Son 3 Ay</option>
                            <option value="365">Son 1 Yıl</option>
                        </select>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="card">
                    <div class="analytics-tabs" style="display: flex; border-bottom: 1px solid var(--border-color);">
                        <button class="analytics-tab active" data-tab="customers">Müşteri Analizi</button>
                        <button class="analytics-tab" data-tab="services">Hizmet Analizi</button>
                        <button class="analytics-tab" data-tab="history">Randevu Geçmişi</button>
                    </div>

                    <!-- Customer Analytics Tab -->
                    <div id="customersTab" class="analytics-tab-content" style="padding: var(--spacing-lg);">
                        <h3 style="margin-bottom: var(--spacing-md);">En Çok Gelen Müşteriler</h3>
                        <div id="topCustomersTable"></div>
                    </div>

                    <!-- Services Analytics Tab -->
                    <div id="servicesTab" class="analytics-tab-content hidden" style="padding: var(--spacing-lg);">
                        <h3 style="margin-bottom: var(--spacing-md);">Popüler Hizmetler</h3>
                        <div
                            style="display: grid; grid-template-columns: 2fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
                            <div>
                                <canvas id="servicesBarChart" style="max-height: 400px;"></canvas>
                            </div>
                            <div>
                                <canvas id="servicesPieChart" style="max-height: 400px;"></canvas>
                            </div>
                        </div>
                        <div id="popularServicesTable"></div>
                    </div>

                    <!-- Appointment History Tab -->
                    <div id="historyTab" class="analytics-tab-content hidden" style="padding: var(--spacing-lg);">
                        <h3 style="margin-bottom: var(--spacing-md);">Randevu Geçmişi</h3>
                        <div style="margin-bottom: var(--spacing-md); display: flex; gap: var(--spacing-md);">
                            <select id="statusFilter" class="form-control" style="width: auto;">
                                <option value="">Tüm Durumlar</option>
                                <option value="completed">Tamamlandı</option>
                                <option value="cancelled">İptal Edildi</option>
                                <option value="pending">Bekliyor</option>
                            </select>
                        </div>
                        <div id="appointmentsHistoryTable"></div>
                        <div id="paginationControls" style="margin-top: var(--spacing-md); text-align: center;"></div>
                    </div>
                </div>
            </div>

            <!-- Staff Page -->
            <div id="staffPage" class="page-content hidden">
                <div class="mb-md">
                    <h1>Personel Yönetimi</h1>
                    <p>&copy; 2026 Kuaför Aura - Profesyonel Yönetim Paneli</p>
                    <p style="color: var(--text-muted); font-size: 0.875rem; margin-top: 0.5rem;">Personel kayıtları <a
                            href="/staff-register.html" style="color: var(--primary);">kayıt sayfası</a> üzerinden
                        yapılır ve onayınız beklenir.</p>
                </div>

                <div class="card">
                    <table id="staffTable">
                        <thead>
                            <tr>
                                <th>Ad Soyad</th>
                                <th>Kullanıcı Adı</th>
                                <th>E-posta</th>
                                <th>Telefon</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Catalog Page -->
            <div id="catalogPage" class="page-content hidden">
                <div class="flex-between mb-md">
                    <h1>Hizmet Kataloğu</h1>
                    <button class="btn btn-primary btn-sm" onclick="showAddServiceModal()"><i class="fas fa-plus"></i>
                        Hizmet Ekle</button>
                </div>

                <div class="card">
                    <table id="catalogTable">
                        <thead>
                            <tr>
                                <th>Hizmet</th>
                                <th>Kategori</th>
                                <th>Süre</th>
                                <th>Fiyat</th>
                                <th>Malzeme</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Stock Page -->
            <div id="stockPage" class="page-content hidden">
                <div class="flex-between mb-md">
                    <h1>Stok Yönetimi</h1>
                    <button class="btn btn-primary btn-sm" onclick="showAddStockModal()"><i class="fas fa-plus"></i>
                        Stok Ekle</button>
                </div>

                <div class="card">
                    <table id="stockTable">
                        <thead>
                            <tr>
                                <th>Ürün</th>
                                <th>Tip</th>
                                <th>Miktar</th>
                                <th>Birim</th>
                                <th>Birim Maliyet</th>
                                <th>Son Güncelleme</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
    </div>
    </main>

    <!-- Staff Details Modal (Pro) -->
    <div id="staffDetailsModal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="staffDetailName">Personel Detayları</h2>
                <button class="modal-close" onclick="closeStaffDetailsModal()">×</button>
            </div>

            <div class="modal-tabs">
                <div class="modal-tab active" onclick="switchStaffTab('commissions')">Özel Pirimler</div>
                <div class="modal-tab" onclick="switchStaffTab('hours')">Çalışma Saatleri</div>
                <div class="modal-tab" onclick="switchStaffTab('advances')">Avans & Ödemeler</div>
            </div>

            <!-- Commissions Tab -->
            <div id="tab-commissions" class="tab-pane active">
                <p class="text-muted mb-md" style="font-size: 0.875rem;">Bu personele özel hizmet bazlı pirim oranları
                    tanımlayın. Tanımlanmayan hizmetler için genel oran (%15) geçerli kalır.</p>
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="table-mini" id="staffCommissionsTable">
                        <thead>
                            <tr>
                                <th>Hizmet</th>
                                <th>Kategori</th>
                                <th>Normal Fiyat</th>
                                <th style="width: 120px;">Özel Oran (%)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="modal-footer mt-md">
                    <button class="btn btn-primary" onclick="saveStaffCommissions()">Pirimleri Kaydet</button>
                </div>
            </div>

            <!-- Hours Tab -->
            <div id="tab-hours" class="tab-pane">
                <p class="text-muted mb-md" style="font-size: 0.875rem;">Personelin haftalık çalışma saatlerini
                    düzenleyin.</p>
                <table class="table-mini" id="staffHoursTable">
                    <thead>
                        <tr>
                            <th>Gün</th>
                            <th>Başlangıç</th>
                            <th>Bitiş</th>
                            <th>İzinli</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Days 0-6 will be here -->
                    </tbody>
                </table>
                <div class="modal-footer mt-md">
                    <button class="btn btn-primary" onclick="saveStaffHours()">Saatleri Kaydet</button>
                </div>
            </div>

            <!-- Advances Tab -->
            <div id="tab-advances" class="tab-pane">
                <div class="form-row" style="align-items: flex-end; margin-bottom: var(--spacing-lg); gap: 1rem;">
                    <div class="form-group" style="flex: 1;">
                        <label>Miktar (₺)</label>
                        <input type="number" id="advanceAmount" class="form-control" placeholder="0.00">
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Açıklama</label>
                        <input type="text" id="advanceDesc" class="form-control" placeholder="Örn: Haftalık avans">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="addStaffAdvance()">Ekle</button>
                    </div>
                </div>

                <h3>Son Ödemeler</h3>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="table-mini" id="staffAdvancesTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Miktar</th>
                                <th>Açıklama</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Add Modal -->
    <div id="serviceModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Yeni Hizmet Ekle</h2>
                <button class="modal-close" onclick="closeServiceModal()">×</button>
            </div>
            <form id="serviceForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label>Hizmet Adı *</label>
                    <input type="text" name="name" required class="form-control">
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select name="category" class="form-control">
                        <option value="">Seçiniz</option>
                        <option value="Saç">Saç</option>
                        <option value="Makyaj">Makyaj</option>
                        <option value="Cilt Bakımı">Cilt Bakımı</option>
                        <option value="Tırnak">Tırnak</option>
                        <option value="Diğer">Diğer</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Fiyat (₺) *</label>
                        <input type="number" name="price" required class="form-control" min="0" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Süre (dakika) *</label>
                        <input type="number" name="duration" required class="form-control" min="15" step="15">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Şampuan Kullanımı (gr)</label>
                        <input type="number" name="shampoo_usage" class="form-control" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Boya Kullanımı (cl)</label>
                        <input type="number" name="dye_usage" class="form-control" min="0" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Açıklama</label>
                    <textarea name="description" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeServiceModal()">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stock Add Modal -->
    <!-- Manual Appointment Modal -->
    <div id="appointmentModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2>Manuel Randevu Oluştur</h2>
                <button class="modal-close" onclick="closeAppointmentModal()">×</button>
            </div>
            <form id="appointmentForm">
                <div class="form-group">
                    <label>Müşteri Ad Soyad *</label>
                    <input type="text" name="customer_name" required class="form-control" placeholder="Örn: Ali Yılmaz">
                </div>
                <div class="form-group">
                    <label>Müşteri Telefon *</label>
                    <input type="tel" name="customer_phone" required class="form-control" placeholder="05xx xxx xx xx">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tarih *</label>
                        <input type="date" name="appointment_date" required class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Saat *</label>
                        <input type="time" name="appointment_time" required class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Hizmet *</label>
                    <select name="service_id" id="aptServiceSelect" required class="form-control">
                        <option value="">Seçiniz</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Personel *</label>
                    <select name="staff_id" id="aptStaffSelect" required class="form-control">
                        <option value="">Seçiniz</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAppointmentModal()">İptal</button>
                    <button type="submit" class="btn btn-primary">Randevu Oluştur</button>
                </div>
            </form>
        </div>
    </div>

    <div id="stockModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Yeni Stok Ekle</h2>
                <button class="modal-close" onclick="closeStockModal()">×</button>
            </div>
            <form id="stockForm">
                <div class="form-group">
                    <label>Ürün Adı *</label>
                    <input type="text" name="item_name" required class="form-control">
                </div>
                <div class="form-group">
                    <label>Tip *</label>
                    <select name="item_type" required class="form-control">
                        <option value="">Seçiniz</option>
                        <option value="shampoo">Şampuan</option>
                        <option value="dye">Boya</option>
                        <option value="other">Diğer</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Miktar *</label>
                        <input type="number" name="quantity" required class="form-control" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label>Birim *</label>
                        <select name="unit" required class="form-control">
                            <option value="gr">Gram</option>
                            <option value="cl">cl</option>
                            <option value="adet">Adet</option>
                            <option value="litre">Litre</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Birim Maliyet (₺) *</label>
                    <input type="number" name="unit_cost" required class="form-control" min="0" step="0.01">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeStockModal()">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border-color);
        }

        /* Analytics Styles */
        .analytics-tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-muted);
            transition: all var(--transition-fast);
        }

        .analytics-tab:hover {
            color: var(--text-primary);
        }

        .analytics-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .analytics-tab-content.hidden {
            display: none;
        }

        .customer-widget-item,
        .service-widget-item {
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .customer-widget-item:hover,
        .service-widget-item:hover {
            background: var(--bg-secondary);
        }
    </style>


    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/ai-chat.js"></script>
    <script>
        // Auth check
        if (!UserManager.isLoggedIn() || !checkRole('PATRON')) {
            window.location.href = '/login.html';
        }

        // User info
        const user = UserManager.get();
        document.getElementById('userInfo').textContent = user.full_name;

        // Menu navigation
        document.querySelectorAll('.menu-item[data-page]').forEach(item => {
            item.addEventListener('click', function () {
                const page = this.dataset.page;

                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));

                this.classList.add('active');
                document.getElementById(page + 'Page').classList.remove('hidden');

                // Load page data
                if (page === 'dashboard') loadDashboard();
                else if (page === 'appointments') loadAppointments();
                else if (page === 'analytics') loadAnalytics();
                else if (page === 'staff') loadStaff();
                else if (page === 'catalog') loadCatalog();
                else if (page === 'stock') loadStock();
            });
        });

        // Load dashboard
        let revenueChart = null;

        async function loadDashboard() {
            try {
                const data = await apiCall('/patron/analytics');

                // Stats - 4 kart
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Toplam Randevu</div>
                        <div class="stat-value" style="color: var(--info)">${data.stats.totalAppointments || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Toplam Gelir</div>
                        <div class="stat-value" style="color: var(--success)">${formatCurrency(data.stats.totalRevenue || 0)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Aktif Personel</div>
                        <div class="stat-value" style="color: var(--primary)">${data.stats.activeStaff || 0}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Bu Ay Prim</div>
                        <div class="stat-value" style="color: var(--warning)">${formatCurrency(data.stats.totalCommission || 0)}</div>
                    </div>
                `;

                // Render chart
                renderRevenueChart();

                // Staff performance
                const staffPerf = document.getElementById('staffPerformance');
                if (!data.staffPerformance || data.staffPerformance.length === 0) {
                    staffPerf.innerHTML = '<p class="text-muted" style="padding: var(--spacing-md);">Henüz veri yok</p>';
                } else {
                    staffPerf.innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Personel</th>
                                    <th>Randevu</th>
                                    <th>Ciro</th>
                                    <th>Prim</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.staffPerformance.map(s => `
                                    <tr>
                                        <td><strong>${s.full_name}</strong></td>
                                        <td>${s.appointment_count || 0}</td>
                                        <td>${formatCurrency(s.revenue || 0)}</td>
                                        <td>${formatCurrency(s.total_commission || 0)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                showToast('Veriler yüklenemedi: ' + error.message, 'error');
            }
        }

        function renderRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;

            if (revenueChart) {
                revenueChart.destroy();
            }

            const labels = [];
            const revenues = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' }));
                revenues.push(Math.floor(Math.random() * 5000) + 1000);
            }

            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Gelir (₺)',
                        data: revenues,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => '₺' + value.toLocaleString('tr-TR'),
                                color: '#9ca3af'
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        }
                    }
                }
            });
        }

        // Load staff
        async function loadStaff() {
            try {
                const data = await apiCall('/patron/staff');
                const tbody = document.querySelector('#staffTable tbody');

                if (data.staff.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Personel bulunamadı</td></tr>';
                    return;
                }

                tbody.innerHTML = data.staff.map(staff => `
                    <tr>
                        <td><strong>${staff.full_name}</strong></td>
                        <td>${staff.username}</td>
                        <td>${staff.email || '-'}</td>
                        <td>${staff.phone || '-'}</td>
                        <td>
                            ${staff.is_active ?
                        '<span class="badge badge-success">Aktif</span>' :
                        '<span class="badge badge-danger">Pasif</span>'
                    }
                        </td>
                        <td>
                            <button class="btn btn-${staff.is_active ? 'danger' : 'success'}" 
                                    onclick="toggleStaff(${staff.id}, ${!staff.is_active})">
                                ${staff.is_active ? 'Pasifleştir' : 'Aktifleştir'}
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showToast('Personel listesi yüklenemedi: ' + error.message, 'error');
            }
        }

        // Load catalog
        async function loadCatalog() {
            try {
                const data = await apiCall('/patron/catalog');
                const tbody = document.querySelector('#catalogTable tbody');

                if (data.services.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Hizmet bulunamadı</td></tr>';
                    return;
                }

                tbody.innerHTML = data.services.map(service => `
                    <tr>
                        <td><strong>${service.name}</strong></td>
                        <td>${service.category || '-'}</td>
                        <td>${formatDuration(service.duration)}</td>
                        <td><strong>${formatCurrency(service.price)}</strong></td>
                        <td>
                            ${service.shampoo_usage > 0 ? `Şampuan: ${service.shampoo_usage}gr<br/>` : ''}
                            ${service.dye_usage > 0 ? `Boya: ${service.dye_usage}cl` : ''}
                        </td>
                        <td>
                            ${service.is_active ?
                        '<span class="badge badge-success">Aktif</span>' :
                        '<span class="badge badge-danger">Pasif</span>'
                    }
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                showToast('Katalog yüklenemedi: ' + error.message, 'error');
            }
        }

        // Load stock
        async function loadStock() {
            try {
                const data = await apiCall('/patron/stock');
                const tbody = document.querySelector('#stockTable tbody');

                if (data.stock.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Stok bulunamadı</td></tr>';
                    return;
                }

                tbody.innerHTML = data.stock.map(item => `
                    <tr>
                        <td><strong>${item.item_name}</strong></td>
                        <td>
                            ${item.item_type === 'shampoo' ? 'Şampuan' :
                        item.item_type === 'dye' ? 'Boya' : 'Diğer'}
                        </td>
                        <td style="color: ${item.quantity < 100 ? 'var(--danger)' : 'var(--success)'}">
                            <strong>${item.quantity}</strong>
                        </td>
                        <td>${item.unit}</td>
                        <td>${formatCurrency(item.unit_cost)}</td>
                        <td>${formatDateTime(item.last_updated)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                showToast('Stok listesi yüklenemedi: ' + error.message, 'error');
            }
        }

        // Toggle staff
        async function toggleStaff(staffId, isActive) {
            try {
                await apiCall(`/patron/staff/${staffId}/toggle`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: isActive })
                });
                showToast(isActive ? 'Personel aktifleştirildi' : 'Personel pasifleştirildi', 'success');
                loadStaff();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Add staff modal
        function showAddStaffModal() {
            const username = prompt('Kullanıcı Adı:');
            if (!username) return;

            const password = prompt('Şifre:');
            if (!password) return;

            const full_name = prompt('Ad Soyad:');
            if (!full_name) return;

            const email = prompt('E-posta (opsiyonel):');
            const phone = prompt('Telefon (opsiyonel):');

            addStaff({ username, password, full_name, email, phone });
        }

        async function addStaff(data) {
            try {
                await apiCall('/patron/staff', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                showToast('Personel başarıyla eklendi', 'success');
                loadStaff();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Service Modal Functions
        function showAddServiceModal() {
            document.getElementById('serviceModal').classList.remove('hidden');
        }

        function closeServiceModal() {
            document.getElementById('serviceModal').classList.add('hidden');
            document.getElementById('serviceForm').reset();
        }

        // Handle service form submission
        document.getElementById('serviceForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const form = e.target;

            // Collect form data as JSON (simpler, no file upload for now)
            const serviceData = {
                name: form.querySelector('[name="name"]').value,
                category: form.querySelector('[name="category"]').value,
                price: form.querySelector('[name="price"]').value,
                duration: form.querySelector('[name="duration"]').value,
                shampoo_usage: form.querySelector('[name="shampoo_usage"]').value || '0',
                dye_usage: form.querySelector('[name="dye_usage"]').value || '0',
                description: form.querySelector('[name="description"]').value || ''
            };

            console.log('=== Submitting Service ===');
            console.log(serviceData);

            try {
                const response = await apiCall('/patron/catalog-simple', {
                    method: 'POST',
                    body: JSON.stringify(serviceData)
                });

                console.log('✅ Success:', response);
                showToast('Hizmet başarıyla eklendi', 'success');
                closeServiceModal();
                form.reset();
                loadCatalog();
            } catch (error) {
                console.error('❌ Error:', error);
                showToast(error.message, 'error');
            }
        });

        // Appointment Modal Functions
        async function showManualAppointmentModal() {
            try {
                // Load services and staff
                const [servicesData, staffData] = await Promise.all([
                    apiCall('/patron/catalog'),
                    apiCall('/patron/staff')
                ]);

                const serviceSelect = document.getElementById('aptServiceSelect');
                const staffSelect = document.getElementById('aptStaffSelect');

                serviceSelect.innerHTML = '<option value="">Seçiniz</option>' +
                    servicesData.services.filter(s => s.is_active).map(s =>
                        `<option value="${s.id}">${s.name} (${formatCurrency(s.price)})</option>`
                    ).join('');

                staffSelect.innerHTML = '<option value="">Seçiniz</option>' +
                    staffData.staff.filter(s => s.is_active).map(s =>
                        `<option value="${s.id}">${s.full_name}</option>`
                    ).join('');

                document.getElementById('appointmentModal').classList.remove('hidden');
            } catch (error) {
                showToast('Veriler yüklenemedi: ' + error.message, 'error');
            }
        }

        function closeAppointmentModal() {
            document.getElementById('appointmentModal').classList.add('hidden');
            document.getElementById('appointmentForm').reset();
        }

        document.getElementById('appointmentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                await apiCall('/patron/appointments/manual', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                showToast('Randevu başarıyla oluşturuldu', 'success');
                closeAppointmentModal();
                loadAppointments();
            } catch (error) {
                showToast(error.message, 'error');
            }
        });

        // Stock Modal Functions
        function showAddStockModal() {
            document.getElementById('stockModal').classList.remove('hidden');
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.add('hidden');
            document.getElementById('stockForm').reset();
        }

        // Handle stock form submission
        document.getElementById('stockForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                await apiCall('/patron/stock', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });

                showToast('Stok başarıyla eklendi', 'success');
                closeStockModal();
                loadStock();
            } catch (error) {
                showToast(error.message, 'error');
            }
        });

        // Navigate to analytics page
        function navigateToAnalytics() {
            document.querySelector('.menu-item[data-page="analytics"]').click();
        }

        // Analytics Tab Navigation
        document.querySelectorAll('.analytics-tab').forEach(tab => {
            tab.addEventListener('click', function () {
                const tabName = this.dataset.tab;

                document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.analytics-tab-content').forEach(c => c.classList.add('hidden'));

                this.classList.add('active');
                document.getElementById(tabName + 'Tab').classList.remove('hidden');
            });
        });

        // Date range filter
        let currentDateRange = 30;
        document.getElementById('dateRangeFilter')?.addEventListener('change', function () {
            currentDateRange = parseInt(this.value);
            loadAnalytics();
        });

        // Status filter
        document.getElementById('statusFilter')?.addEventListener('change', function () {
            loadAppointmentHistory();
        });

        // Analytics variables
        let servicesBarChart = null;
        let servicesPieChart = null;
        let currentPage = 1;

        // Load Analytics Page
        async function loadAnalytics() {
            await loadTopCustomers();
            await loadPopularServices();
            await loadAppointmentHistory();
        }

        // Load dashboard widgets
        async function loadDashboardWidgets() {
            try {
                // Top customers widget
                const customersData = await apiCall(`/patron/analytics/top-customers?days=30&limit=3`);
                const topCustomersWidget = document.getElementById('topCustomersWidget');

                if (customersData.data && customersData.data.length > 0) {
                    topCustomersWidget.innerHTML = customersData.data.map((customer, index) => `
                        <div class="customer-widget-item">
                            <div>
                                <strong>${index + 1}. ${customer.customer_name}</strong>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${customer.customer_phone}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: var(--primary);">${customer.visit_count} ziyaret</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${formatCurrency(customer.total_spent)}</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    topCustomersWidget.innerHTML = '<p class="text-muted">Henüz veri yok</p>';
                }

                // Popular services widget
                const servicesData = await apiCall(`/patron/analytics/popular-services?days=30`);
                const popularServicesWidget = document.getElementById('popularServicesWidget');

                if (servicesData.data && servicesData.data.length > 0) {
                    const topServices = servicesData.data.slice(0, 3);
                    popularServicesWidget.innerHTML = topServices.map((service, index) => `
                        <div class="service-widget-item">
                            <div>
                                <strong>${index + 1}. ${service.name}</strong>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${service.category || 'Kategori yok'}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 600; color: var(--success);">${service.booking_count} randevu</div>
                                <div style="font-size: 0.75rem; color: var(--text-muted);">${service.percentage}%</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    popularServicesWidget.innerHTML = '<p class="text-muted">Henüz veri yok</p>';
                }
            } catch (error) {
                console.error('Widget loading error:', error);
            }
        }

        // Load top customers
        async function loadTopCustomers() {
            try {
                const data = await apiCall(`/patron/analytics/top-customers?days=${currentDateRange}&limit=10`);
                const container = document.getElementById('topCustomersTable');

                if (!data.data || data.data.length === 0) {
                    container.innerHTML = '<p class="text-muted">Henüz veri yok</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Müşteri</th>
                                <th>Telefon</th>
                                <th>Ziyaret</th>
                                <th>Toplam Harcama</th>
                                <th>Son Ziyaret</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map((customer, index) => `
                                <tr>
                                    <td><strong>${index + 1}</strong></td>
                                    <td><strong>${customer.customer_name}</strong></td>
                                    <td>${customer.customer_phone}</td>
                                    <td><span style="color: var(--primary); font-weight: 600;">${customer.visit_count}</span></td>
                                    <td><strong>${formatCurrency(customer.total_spent)}</strong></td>
                                    <td>${formatDate(customer.last_visit)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                showToast('Müşteri verileri yüklenemedi: ' + error.message, 'error');
            }
        }

        // Load popular services
        async function loadPopularServices() {
            try {
                const data = await apiCall(`/patron/analytics/popular-services?days=${currentDateRange}`);

                if (!data.data || data.data.length === 0) {
                    document.getElementById('popularServicesTable').innerHTML = '<p class="text-muted">Henüz veri yok</p>';
                    return;
                }

                // Render charts
                renderServicesCharts(data.data);

                // Render table
                document.getElementById('popularServicesTable').innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Hizmet</th>
                                <th>Kategori</th>
                                <th>Rezervasyon</th>
                                <th>Oran</th>
                                <th>Toplam Gelir</th>
                                <th>Ort. Fiyat</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map((service, index) => `
                                <tr>
                                    <td><strong>${index + 1}</strong></td>
                                    <td><strong>${service.name}</strong></td>
                                    <td>${service.category || '-'}</td>
                                    <td><span style="color: var(--primary); font-weight: 600;">${service.booking_count}</span></td>
                                    <td><span style="color: var(--success);">${service.percentage}%</span></td>
                                    <td><strong>${formatCurrency(service.total_revenue)}</strong></td>
                                    <td>${formatCurrency(service.avg_price)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                showToast('Hizmet verileri yüklenemedi: ' + error.message, 'error');
            }
        }

        // Render services charts
        function renderServicesCharts(services) {
            // Bar Chart
            const barCtx = document.getElementById('servicesBarChart');
            if (barCtx) {
                if (servicesBarChart) servicesBarChart.destroy();

                const topServices = services.slice(0, 10);
                servicesBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: topServices.map(s => s.name),
                        datasets: [{
                            label: 'Rezervasyon Sayısı',
                            data: topServices.map(s => s.booking_count),
                            backgroundColor: 'rgba(99, 102, 241, 0.8)',
                            borderColor: 'rgba(99, 102, 241, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            }
                        }
                    }
                });
            }

            // Pie Chart
            const pieCtx = document.getElementById('servicesPieChart');
            if (pieCtx) {
                if (servicesPieChart) servicesPieChart.destroy();

                const topServices = services.slice(0, 5);
                const colors = ['#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'];

                servicesPieChart = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: topServices.map(s => s.name),
                        datasets: [{
                            data: topServices.map(s => s.booking_count),
                            backgroundColor: colors,
                            borderColor: '#1f2937',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#9ca3af', padding: 15 }
                            }
                        }
                    }
                });
            }
        }

        // Load appointment history
        async function loadAppointmentHistory(page = 1) {
            try {
                const status = document.getElementById('statusFilter')?.value || '';
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - currentDateRange);

                const params = new URLSearchParams({
                    page,
                    limit: 20,
                    startDate: startDate.toISOString().split('T')[0]
                });

                if (status) params.append('status', status);

                const data = await apiCall(`/patron/analytics/appointments?${params}`);
                const container = document.getElementById('appointmentsHistoryTable');

                if (!data.data || data.data.length === 0) {
                    container.innerHTML = '<p class="text-muted">Randevu bulunamadı</p>';
                    document.getElementById('paginationControls').innerHTML = '';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Saat</th>
                                <th>Müşteri</th>
                                <th>Hizmet</th>
                                <th>Personel</th>
                                <th>Fiyat</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map(apt => `
                                <tr>
                                    <td>${formatDate(apt.appointment_date)}</td>
                                    <td><strong>${apt.appointment_time}</strong></td>
                                    <td>
                                        <strong>${apt.customer_name}</strong><br/>
                                        <span style="font-size: 0.75rem; color: var(--text-muted);">${apt.customer_phone}</span>
                                    </td>
                                    <td>${apt.service_name}</td>
                                    <td>${apt.staff_name}</td>
                                    <td><strong>${formatCurrency(apt.service_price)}</strong></td>
                                    <td>
                                        <span class="badge badge-${apt.status === 'completed' ? 'success' : apt.status === 'cancelled' ? 'danger' : 'warning'}">
                                            ${apt.status === 'completed' ? 'Tamamlandı' : apt.status === 'cancelled' ? 'İptal' : 'Bekliyor'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                // Pagination
                if (data.pagination && data.pagination.totalPages > 1) {
                    const pagination = data.pagination;
                    let paginationHTML = '<div style="display: flex; gap: 0.5rem; justify-content: center;">';

                    if (pagination.page > 1) {
                        paginationHTML += `<button class="btn btn-secondary btn-sm" onclick="loadAppointmentHistory(${pagination.page - 1})">← Önceki</button>`;
                    }

                    paginationHTML += `<span style="padding: 0.5rem 1rem;">Sayfa ${pagination.page} / ${pagination.totalPages}</span>`;

                    if (pagination.page < pagination.totalPages) {
                        paginationHTML += `<button class="btn btn-secondary btn-sm" onclick="loadAppointmentHistory(${pagination.page + 1})">Sonraki →</button>`;
                    }

                    paginationHTML += '</div>';
                    document.getElementById('paginationControls').innerHTML = paginationHTML;
                } else {
                    document.getElementById('paginationControls').innerHTML = '';
                }

                currentPage = page;
            } catch (error) {
                showToast('Randevu geçmişi yüklenemedi: ' + error.message, 'error');
            }
        }

        // Load pending staff approvals
        async function loadPendingStaff() {
            try {
                const data = await apiCall('/patron/pending-staff');

                if (!data.pendingStaff || data.pendingStaff.length === 0) {
                    document.getElementById('pendingStaffCard').style.display = 'none';
                    return;
                }

                document.getElementById('pendingStaffCard').style.display = 'block';
                const container = document.getElementById('pendingStaffList');

                container.innerHTML = data.pendingStaff.map(staff => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-sm) var(--spacing-md); background: var(--bg-tertiary); border-radius: var(--radius-sm); margin-bottom: var(--spacing-sm);">
                        <div>
                            <strong style="font-size: 0.9rem;">${staff.full_name}</strong>
                            <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">
                                ${staff.username} • ${staff.phone || 'Telefon yok'} • ${formatDateTime(staff.created_at)}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-icon active" onclick="approveStaff(${staff.id})" title="Onayla">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn-icon active-danger" onclick="rejectStaff(${staff.id})" title="Reddet">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Bekleyen personel yükleme hatası:', error);
            }
        }

        // Approve staff
        async function approveStaff(staffId) {
            if (!confirmAction('Bu personeli onaylamak istediğinizden emin misiniz?')) return;

            try {
                await apiCall(`/patron/staff/${staffId}/approve`, { method: 'POST' });
                showToast('Personel onaylandı', 'success');
                loadPendingStaff();
                loadStaff(); // Refresh staff list
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Reject staff
        async function rejectStaff(staffId) {
            if (!confirmAction('Bu personeli reddetmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) return;

            try {
                await apiCall(`/patron/staff/${staffId}/reject`, { method: 'POST' });
                showToast('Personel reddedildi', 'success');
                loadPendingStaff();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ===== RANDEVU YÖNETİMİ =====
        async function loadAppointments() {
            try {
                const status = document.getElementById('filterStatus').value;
                const staff_id = document.getElementById('filterStaff').value;
                const date_from = document.getElementById('filterDateFrom').value;
                const date_to = document.getElementById('filterDateTo').value;

                const params = new URLSearchParams();
                if (status) params.append('status', status);
                if (staff_id) params.append('staff_id', staff_id);
                if (date_from) params.append('date_from', date_from);
                if (date_to) params.append('date_to', date_to);

                const data = await apiCall(`/patron/appointments?${params.toString()}`);

                const tbody = document.querySelector('#appointmentsTable tbody');

                if (data.appointments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted);">Randevu bulunamadı</td></tr>';
                    return;
                }

                tbody.innerHTML = data.appointments.map(apt => {
                    const statusBadge = {
                        'pending': '<span class="badge badge-warning">Bekliyor</span>',
                        'completed': '<span class="badge badge-success">Tamamlandı</span>',
                        'cancelled': '<span class="badge badge-danger">İptal</span>',
                        'no_show': '<span class="badge badge-secondary">Gelmedi</span>'
                    }[apt.status] || apt.status;

                    const actions = apt.status === 'pending'
                        ? `<button class="btn-icon active" onclick="completeAppointment(${apt.id})" title="Tamamla">
                               <i class="fas fa-check"></i>
                           </button>
                           <button class="btn-icon active-danger" onclick="cancelAppointment(${apt.id})" title="İptal">
                               <i class="fas fa-times"></i>
                           </button>`
                        : '-';

                    return `
                        <tr>
                            <td>${formatDate(apt.appointment_date)} ${apt.appointment_time}</td>
                            <td>
                                <strong>${apt.customer_name}</strong><br>
                                <small style="color: var(--text-muted);">${apt.customer_phone}</small>
                            </td>
                            <td>${apt.service_name}</td>
                            <td>${apt.staff_name}</td>
                            <td>${formatCurrency(apt.service_price)}</td>
                            <td>${statusBadge}</td>
                            <td style="white-space: nowrap;">${actions}</td>
                        </tr>
                    `;
                }).join('');

                // Load staff for filter
                if (!document.getElementById('filterStaff').options.length > 1) {
                    const staffData = await apiCall('/patron/staff');
                    const filterStaff = document.getElementById('filterStaff');
                    staffData.staff.forEach(staff => {
                        const option = document.createElement('option');
                        option.value = staff.id;
                        option.textContent = staff.full_name;
                        filterStaff.appendChild(option);
                    });
                }

            } catch (error) {
                console.error('Randevu yükleme hatası:', error);
                showToast(error.message, 'error');
            }
        }

        async function completeAppointment(appointmentId) {
            if (!confirmAction('Bu randevuyu tamamlamak istediğinizden emin misiniz?\n\nOtomatik olarak:\n- Finans kaydı oluşturulacak\n- Stoktan malzeme düşülecek\n- Komisyon hesaplanacak')) {
                return;
            }

            try {
                const data = await apiCall(`/patron/appointments/${appointmentId}/complete`, {
                    method: 'POST'
                });

                showToast(`Randevu tamamlandı!\n\nGelir: ${formatCurrency(data.finance.revenue)}\nMalzeme: ${formatCurrency(data.finance.materialCost)}\nKomisyon: ${formatCurrency(data.finance.commission)}`, 'success');
                loadAppointments();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function cancelAppointment(appointmentId) {
            if (!confirmAction('Bu randevuyu iptal etmek istediğinize emin misiniz?')) return;

            try {
                await apiCall(`/patron/appointments/${appointmentId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ status: 'cancelled' })
                });

                showToast('Randevu iptal edildi', 'success');
                loadAppointments();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ===== PERSONEL YÖNETİMİ =====
        async function loadStaff() {
            try {
                const data = await apiCall('/patron/staff');
                const tbody = document.querySelector('#staffTable tbody');

                if (data.staff.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted);">Henüz personel yok</td></tr>';
                    return;
                }

                tbody.innerHTML = data.staff.map(staff => {
                    const statusBadge = staff.is_active
                        ? '<span class="status-badge active"><i class="fas fa-check-circle"></i> Aktif</span>'
                        : '<span class="status-badge inactive"><i class="fas fa-times-circle"></i> Pasif</span>';

                    const commissionRate = (staff.commission_rate * 100).toFixed(0);

                    return `
                        <tr>
                            <td><strong>${staff.full_name}</strong></td>
                            <td>${staff.username}</td>
                            <td>${staff.email || '-'}</td>
                            <td>${staff.phone || '-'}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="action-group">
                                    <button class="btn-icon ${staff.is_active ? 'active' : ''}" onclick="toggleStaffStatus(${staff.id}, true)" title="Aktifleştir">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn-icon ${!staff.is_active ? 'active-danger' : ''}" onclick="toggleStaffStatus(${staff.id}, false)" title="Pasifleştir">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="action-btn" onclick="editCommission(${staff.id}, ${staff.commission_rate})" title="Pirim Oranı: %${commissionRate}">
                                        <i class="fas fa-percent"></i> %${commissionRate}
                                    </button>
                                    <button class="btn-icon" onclick="showStaffDetails(${staff.id})" title="Detaylar & Ayarlar">
                                        <i class="fas fa-cog"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Personel yükleme hatası:', error);
                showToast(error.message, 'error');
            }
        }

        let currentStaffId = null;

        async function showStaffDetails(staffId) {
            currentStaffId = staffId;
            try {
                const data = await apiCall(`/patron/staff/${staffId}/details`);

                document.getElementById('staffDetailName').innerText = `${data.staff.full_name} - Detaylar`;

                // Commissions Table
                const commsBody = document.querySelector('#staffCommissionsTable tbody');
                commsBody.innerHTML = data.commissions.map(c => `
                    <tr>
                        <td>${c.service_name}</td>
                        <td>${c.category}</td>
                        <td>${formatCurrency(c.service_price)}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm comm-input" 
                                   data-service-id="${c.service_id}" 
                                   value="${c.custom_rate > 0 ? (c.custom_rate * 100).toFixed(0) : ''}" 
                                   placeholder="15">
                        </td>
                    </tr>
                `).join('');

                // Hours Table
                const days = ['Pazar', 'Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi'];
                const hoursBody = document.querySelector('#staffHoursTable tbody');
                hoursBody.innerHTML = [0, 1, 2, 3, 4, 5, 6].map(day => {
                    const h = data.hours.find(x => x.day_of_week === day) || { start_time: '09:00', end_time: '19:00', is_off: 0 };
                    return `
                        <tr>
                            <td>${days[day]}</td>
                            <td><input type="time" class="form-control form-control-sm start-input" value="${h.start_time || '09:00'}"></td>
                            <td><input type="time" class="form-control form-control-sm end-input" value="${h.end_time || '19:00'}"></td>
                            <td><input type="checkbox" class="off-input" ${h.is_off ? 'checked' : ''}></td>
                        </tr>
                    `;
                }).join('');

                // Advances Table
                const advBody = document.querySelector('#staffAdvancesTable tbody');
                advBody.innerHTML = data.advances.map(a => `
                    <tr>
                        <td>${formatDateTime(a.date)}</td>
                        <td>${formatCurrency(a.amount)}</td>
                        <td>${a.description || '-'}</td>
                    </tr>
                `).join('');

                document.getElementById('staffDetailsModal').classList.remove('hidden');
                switchStaffTab('commissions');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function switchStaffTab(tab) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));

            const selectedTab = document.querySelector(`.modal-tab[onclick*="${tab}"]`);
            if (selectedTab) selectedTab.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        function closeStaffDetailsModal() {
            document.getElementById('staffDetailsModal').classList.add('hidden');
        }

        async function saveStaffCommissions() {
            const inputs = document.querySelectorAll('.comm-input');
            const commissions = Array.from(inputs)
                .filter(i => i.value !== '')
                .map(i => ({
                    service_id: parseInt(i.dataset.serviceId),
                    rate: parseFloat(i.value) / 100
                }));

            try {
                await apiCall(`/patron/staff/${currentStaffId}/commissions`, {
                    method: 'POST',
                    body: JSON.stringify({ commissions })
                });
                showToast('Özel pirim oranları kaydedildi', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function saveStaffHours() {
            const rows = document.querySelectorAll('#staffHoursTable tbody tr');
            const hours = Array.from(rows).map((row, index) => ({
                day: index,
                start: row.querySelector('.start-input').value,
                end: row.querySelector('.end-input').value,
                is_off: row.querySelector('.off-input').checked
            }));

            try {
                await apiCall(`/patron/staff/${currentStaffId}/hours`, {
                    method: 'POST',
                    body: JSON.stringify({ hours })
                });
                showToast('Çalışma saatleri kaydedildi', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function addStaffAdvance() {
            const amount = parseFloat(document.getElementById('advanceAmount').value);
            const description = document.getElementById('advanceDesc').value;

            if (!amount || amount <= 0) {
                showToast('Geçersiz miktar', 'error');
                return;
            }

            try {
                await apiCall(`/patron/staff/${currentStaffId}/advances`, {
                    method: 'POST',
                    body: JSON.stringify({ amount, description })
                });
                showToast('Ödeme/Avans kaydedildi', 'success');
                document.getElementById('advanceAmount').value = '';
                document.getElementById('advanceDesc').value = '';
                showStaffDetails(currentStaffId); // Refresh tab
                loadFinanceSummary(); // Refresh finance widget
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function toggleStaffStatus(staffId, isActive) {
            try {
                console.log('Toggle staff status:', { staffId, isActive });
                const response = await apiCall(`/patron/staff/${staffId}/toggle`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: isActive })
                });
                console.log('Toggle response:', response);
                showToast(isActive ? 'Personel aktifleştirildi' : 'Personel pasifleştirildi', 'success');
                loadStaff();
            } catch (error) {
                console.error('Toggle error:', error);
                showToast(error.message || 'Sunucu hatası', 'error');
                loadStaff(); // Revert UI
            }
        }

        async function editCommission(staffId, currentRate) {
            const newRate = prompt(`Yeni pirim oranını girin (0-100):`, (currentRate * 100).toFixed(0));
            if (newRate === null) return;

            const rate = parseFloat(newRate) / 100;
            if (isNaN(rate) || rate < 0 || rate > 1) {
                showToast('Geçersiz oran! 0-100 arasında bir değer girin.', 'error');
                return;
            }

            try {
                await apiCall(`/patron/staff/${staffId}/commission`, {
                    method: 'PATCH',
                    body: JSON.stringify({ commission_rate: rate })
                });
                showToast(`Pirim oranı %${(rate * 100).toFixed(0)} olarak güncellendi`, 'success');
                loadStaff();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ===== KATALOG YÖNETİMİ =====
        async function loadCatalog() {
            try {
                const data = await apiCall('/patron/catalog');
                const tbody = document.querySelector('#catalogTable tbody');

                if (data.services.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted);">Henüz hizmet yok</td></tr>';
                    return;
                }

                tbody.innerHTML = data.services.map(service => {
                    const statusBadge = service.is_active
                        ? '<span class="status-badge active"><i class="fas fa-check-circle"></i> Aktif</span>'
                        : '<span class="status-badge inactive"><i class="fas fa-times-circle"></i> Pasif</span>';

                    return `
                        <tr>
                            <td><strong>${service.name}</strong></td>
                            <td>${service.category || '-'}</td>
                            <td>${formatCurrency(service.price)}</td>
                            <td>${service.duration} dk</td>
                            <td>${statusBadge}</td>
                            <td>
                                <div class="action-group">
                                    <button class="btn-icon ${service.is_active ? 'active' : ''}" onclick="toggleServiceStatus(${service.id}, true)" title="Aktifleştir">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn-icon ${!service.is_active ? 'active-danger' : ''}" onclick="toggleServiceStatus(${service.id}, false)" title="Pasifleştir">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Katalog yükleme hatası:', error);
            }
        }

        async function toggleServiceStatus(serviceId, isActive) {
            try {
                await apiCall(`/patron/catalog/${serviceId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ is_active: isActive })
                });
                showToast(isActive ? 'Hizmet aktifleştirildi' : 'Hizmet pasifleştirildi', 'success');
                loadCatalog();
            } catch (error) {
                showToast(error.message, 'error');
                loadCatalog();
            }
        }

        // ===== STOK YÖNETİMİ =====
        async function loadStock() {
            try {
                const data = await apiCall('/patron/stock');
                const tbody = document.querySelector('#stockTable tbody');

                if (data.stock.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: var(--spacing-lg); color: var(--text-muted);">Henüz stok yok</td></tr>';
                    return;
                }

                tbody.innerHTML = data.stock.map(item => {
                    const lowStock = item.quantity < 50;
                    const quantityClass = lowStock ? 'text-danger' : 'text-success';

                    return `
                        <tr>
                            <td><strong>${item.item_name}</strong></td>
                            <td><span class="badge badge-info">${item.item_type}</span></td>
                            <td class="${quantityClass}"><strong>${item.quantity}</strong> ${item.unit}</td>
                            <td>${formatCurrency(item.unit_cost)}</td>
                            <td style="font-size: 0.8125rem; color: var(--text-muted);">${formatDateTime(item.last_updated)}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Stok yükleme hatası:', error);
            }
        }

        // Initial load
        loadDashboard();
        loadDashboardWidgets();
        loadPendingStaff();
    </script>
</body>

</html>